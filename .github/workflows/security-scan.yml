# =============================================================================
# CLOUD SECURITY POSTURE - CI/CD PIPELINE
# =============================================================================
# This workflow has TWO main functions:
#
# 1. CODE QUALITY (runs on every push/PR):
#    - Terraform validation
#    - Python tests and linting
#    - Dependency vulnerability scanning
#
# 2. CLOUD SECURITY SCANNING (runs on schedule or manual trigger):
#    - AWS scanning with Prowler
#    - Azure scanning with ScoutSuite
#    - Findings aggregation
#
# REQUIRED SECRETS (configure in GitHub Settings > Secrets):
# - AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION
# - ARM_CLIENT_ID, ARM_CLIENT_SECRET, ARM_SUBSCRIPTION_ID, ARM_TENANT_ID
# =============================================================================

name: Security Scan CI/CD

# -----------------------------------------------------------------------------
# TRIGGERS: When does this workflow run?
# -----------------------------------------------------------------------------
on:
  # Run on push to main branches (for code quality checks)
  push:
    branches: [main, develop]

  # Run on pull requests (for code quality checks)
  pull_request:
    branches: [main]

  # SCHEDULED: Run full security scans daily at 6 AM UTC
  # Cron: minute hour day-of-month month day-of-week
  schedule:
    - cron: '0 6 * * *'

  # MANUAL: Allow triggering from GitHub Actions UI
  workflow_dispatch:
    inputs:
      run_cloud_scans:
        description: 'Run cloud security scans (Prowler + ScoutSuite)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      scan_aws:
        description: 'Include AWS scan'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      scan_azure:
        description: 'Include Azure scan'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# -----------------------------------------------------------------------------
# ENVIRONMENT VARIABLES
# -----------------------------------------------------------------------------
env:
  PYTHON_VERSION: '3.11'
  PROWLER_OUTPUT_DIR: output
  SCOUTSUITE_OUTPUT_DIR: scoutsuite-report
  AGGREGATED_OUTPUT_DIR: scan-results/aggregated

# =============================================================================
# JOBS
# =============================================================================
jobs:
  # ===========================================================================
  # JOB: Terraform Validation
  # ===========================================================================
  # PURPOSE: Ensure Terraform code is valid and properly formatted
  # RUNS: On every push and pull request
  # ---------------------------------------------------------------------------
  terraform-validate:
    name: Validate Terraform Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      # Check that Terraform files are properly formatted
      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      # Validate AWS Terraform configuration
      - name: Validate AWS Terraform
        working-directory: terraform/aws
        run: |
          terraform init -backend=false
          terraform validate

      # Validate Azure Terraform configuration
      - name: Validate Azure Terraform
        working-directory: terraform/azure
        run: |
          terraform init -backend=false
          terraform validate

  # ===========================================================================
  # JOB: Python Code Quality
  # ===========================================================================
  # PURPOSE: Check Python code formatting and style
  # RUNS: On every push and pull request
  # ---------------------------------------------------------------------------
  code-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: pip install flake8

      # Flake8 checks for Python style issues
      - name: Run Flake8
        run: |
          flake8 scripts/ dashboard/ remediation/ \
            --max-line-length=120 \
            --exclude=venv,__pycache__ \
            --ignore=E501,W503 \
            || true  # Don't fail the build on style issues

  # ===========================================================================
  # JOB: Dependency Security Scan
  # ===========================================================================
  # PURPOSE: Scan for vulnerabilities in dependencies
  # RUNS: On every push and pull request
  # ---------------------------------------------------------------------------
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Trivy scans for known vulnerabilities in dependencies
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true  # Don't block on findings

  # ===========================================================================
  # JOB: AWS Security Scan with Prowler
  # ===========================================================================
  # PURPOSE: Scan AWS environment for security misconfigurations
  # RUNS: On schedule, manual trigger, or when scan scripts change
  # REQUIRES: AWS credentials configured as secrets
  # ---------------------------------------------------------------------------
  aws-security-scan:
    name: AWS Scan (Prowler)
    runs-on: ubuntu-latest

    # Only run on schedule, manual trigger (with cloud scans enabled), or scan script changes
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_cloud_scans == 'true' && github.event.inputs.scan_aws == 'true') ||
      (github.event_name == 'push' && contains(github.event.head_commit.modified, 'scripts/scanning/'))

    # Output the findings count so other jobs can reference it
    outputs:
      findings_count: ${{ steps.count-findings.outputs.count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Install Prowler - the AWS security scanner
      - name: Install Prowler
        run: |
          pip install prowler==3.11.3
          prowler --version

      # Configure AWS credentials from GitHub secrets
      # This is SECURE - credentials are encrypted and never shown in logs
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create output directory
        run: mkdir -p ${{ env.PROWLER_OUTPUT_DIR }}

      # Run the actual security scan
      # -M json: Output JSON for aggregation
      # --ignore-exit-code-3: Prowler returns 3 when findings exist (don't fail)
      - name: Run Prowler AWS scan
        run: |
          echo "=========================================="
          echo "Starting Prowler AWS Security Scan"
          echo "=========================================="
          prowler aws \
            -M json \
            -o ${{ env.PROWLER_OUTPUT_DIR }} \
            --ignore-exit-code-3
          echo "Prowler scan complete!"

      # Count how many security issues were found
      - name: Count findings
        id: count-findings
        run: |
          JSON_FILE=$(find ${{ env.PROWLER_OUTPUT_DIR }} -name "prowler-output-*.json" ! -name "*.ocsf.json" | head -1)
          if [ -f "$JSON_FILE" ]; then
            FAIL_COUNT=$(python3 -c "
          import json
          with open('$JSON_FILE') as f:
              data = json.load(f)
              fails = [x for x in data if x.get('Status') == 'FAIL']
              print(len(fails))
          ")
            echo "count=$FAIL_COUNT" >> $GITHUB_OUTPUT
            echo "Found $FAIL_COUNT AWS security findings"
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      # Save the scan results as an artifact
      # Artifacts can be downloaded from the GitHub Actions UI
      - name: Upload Prowler results
        uses: actions/upload-artifact@v4
        with:
          name: prowler-results
          path: ${{ env.PROWLER_OUTPUT_DIR }}/
          retention-days: 30

  # ===========================================================================
  # JOB: Azure Security Scan with ScoutSuite
  # ===========================================================================
  # PURPOSE: Scan Azure environment for security misconfigurations
  # RUNS: On schedule or manual trigger
  # REQUIRES: Azure service principal credentials as secrets
  # ---------------------------------------------------------------------------
  azure-security-scan:
    name: Azure Scan (ScoutSuite)
    runs-on: ubuntu-latest

    # Only run on schedule or manual trigger with Azure scan enabled
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_cloud_scans == 'true' && github.event.inputs.scan_azure == 'true')

    outputs:
      findings_count: ${{ steps.count-findings.outputs.count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Install ScoutSuite - the multi-cloud security scanner
      - name: Install ScoutSuite
        run: |
          pip install scoutsuite
          scout --version

      # Install Azure CLI for authentication
      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      # Login to Azure using the service principal credentials
      - name: Azure CLI Login
        run: |
          az login --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"
          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
          echo "Logged into Azure subscription"

      - name: Clean and create output directory
        run: |
          rm -rf ${{ env.SCOUTSUITE_OUTPUT_DIR }}
          mkdir -p ${{ env.SCOUTSUITE_OUTPUT_DIR }}

      # Run ScoutSuite Azure security scan
      - name: Run ScoutSuite Azure scan
        run: |
          echo "=========================================="
          echo "Starting ScoutSuite Azure Security Scan"
          echo "=========================================="
          scout azure --cli --no-browser --report-dir ${{ env.SCOUTSUITE_OUTPUT_DIR }} </dev/null || true
          echo "ScoutSuite scan complete!"

      # Count Azure security findings
      - name: Count findings
        id: count-findings
        run: |
          JS_FILE=$(find ${{ env.SCOUTSUITE_OUTPUT_DIR }} -name "scoutsuite_results_azure-*.js" 2>/dev/null | head -1)
          if [ -f "$JS_FILE" ]; then
            FINDING_COUNT=$(python3 << EOF
          import json
          with open("$JS_FILE", 'r') as f:
              content = f.read()
          if 'scoutsuite_results =' in content:
              json_str = content.split('scoutsuite_results =', 1)[1].strip()
              if json_str.startswith('\n'):
                  json_str = json_str[1:]
              data = json.loads(json_str)
              total = 0
              for service in data.get('services', {}).values():
                  for finding in service.get('findings', {}).values():
                      total += finding.get('flagged_items', 0)
              print(total)
          else:
              print(0)
          EOF
          )
            echo "count=$FINDING_COUNT" >> $GITHUB_OUTPUT
            echo "Found $FINDING_COUNT Azure security findings"
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      # Save ScoutSuite results as artifact
      - name: Upload ScoutSuite results
        uses: actions/upload-artifact@v4
        with:
          name: scoutsuite-results
          path: ${{ env.SCOUTSUITE_OUTPUT_DIR }}/
          retention-days: 30

  # ===========================================================================
  # JOB: Aggregate All Findings
  # ===========================================================================
  # PURPOSE: Combine findings from Prowler and ScoutSuite into unified format
  # RUNS: After both scan jobs complete
  # ---------------------------------------------------------------------------
  aggregate-findings:
    name: Aggregate Findings
    runs-on: ubuntu-latest

    # Wait for scan jobs to complete (but run even if one was skipped)
    needs: [aws-security-scan, azure-security-scan]
    if: |
      always() &&
      (needs.aws-security-scan.result == 'success' || needs.azure-security-scan.result == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pandas

      # Download Prowler results from the aws-security-scan job
      - name: Download Prowler results
        if: needs.aws-security-scan.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: prowler-results
          path: ${{ env.PROWLER_OUTPUT_DIR }}
        continue-on-error: true

      # Download ScoutSuite results from the azure-security-scan job
      - name: Download ScoutSuite results
        if: needs.azure-security-scan.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: scoutsuite-results
          path: ${{ env.SCOUTSUITE_OUTPUT_DIR }}
        continue-on-error: true

      # Run our aggregation script
      - name: Run aggregation script
        run: |
          echo "Aggregating security findings from all scanners..."
          python scripts/scanning/aggregate_findings.py

      # Upload the unified aggregated results
      - name: Upload aggregated findings
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-findings
          path: ${{ env.AGGREGATED_OUTPUT_DIR }}/
          retention-days: 90  # Keep longer for trend analysis

      # Create a nice summary in the GitHub Actions UI
      - name: Generate Summary Report
        run: |
          echo "## ðŸ”’ Cloud Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cloud Provider | Scanner | Status | Findings |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|---------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| AWS | Prowler | ${{ needs.aws-security-scan.result || 'skipped' }} | ${{ needs.aws-security-scan.outputs.findings_count || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure | ScoutSuite | ${{ needs.azure-security-scan.result || 'skipped' }} | ${{ needs.azure-security-scan.outputs.findings_count || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **prowler-results**: Raw Prowler JSON output" >> $GITHUB_STEP_SUMMARY
          echo "- **scoutsuite-results**: Raw ScoutSuite report" >> $GITHUB_STEP_SUMMARY
          echo "- **aggregated-findings**: Unified JSON/CSV findings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
